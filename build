#!/bin/bash

#set -eu

CUSTOM="no"

if [ -z $1 ]; then
    CUSTOM="no"
else
    CUSTOM="yes"
fi

export LEIN_SNAPSHOTS_IN_RELEASE="yes"
export LEIN_ROOT="yes"
OS="ref"
WRAP_DIR="src/wrappers"
CLIENT_DIR="src/client"
SERVER_DIR="src/server"

COMMON_COMPONENTS="${WRAP_DIR}/clj_completions ${WRAP_DIR}/shflags ${WRAP_DIR}/${OS}"
SERVER_COMPONENTS="${WRAP_DIR}/project-cljr.clj ${SERVER_DIR}/*.jar ${SERVER_DIR}/jark-deps.txt"
CLIENT_COMPONENTS="${CLIENT_DIR}/jark-client ${CLIENT_DIR}/simplejson.py ${CLIENT_DIR}/termcolor.py"

build_server() {
    echo "Building jark server"
    mkdir -p ${SERVER_DIR}/classes
    javac -d ${SERVER_DIR}/classes/ ${SERVER_DIR}/src/jark/SystemThreadList.java 
    if [ $? != 0 ]; then 
        echo "javac not installed, exiting"
        exit 1
    fi
    cd ${SERVER_DIR}
    echo "Getting dependencies.."
    lein jar

    cd -
    touch ${SERVER_DIR}/jark-deps.txt
    :> ${SERVER_DIR}/jark-deps.txt

    for i in `ls ${SERVER_DIR}/lib/*.jar`; do
        echo $i >> ${SERVER_DIR}/jark-deps.txt
        tar -rf payload.tar $i
    done
    tar -rf payload.tar ${SERVER_COMPONENTS}
}

build_jarkc() {
    CD=$(pwd)
    cd ${CLIENT_DIR}
    runhaskell setup configure --prefix=$HOME --user
    runhaskell setup build
    cd $CD
    cp ${CLIENT_DIR}/dist/build/jarkc/jarkc ${CLIENT_DIR}/jarkc
    chmod +x ${CLIENT_DIR}/jarkc
    rm -rf ${CLIENT_DIR}/dist
}

build_client() {
    tar -rf payload.tar ${CLIENT_COMPONENTS}
}

update_version() {
    local TMPL_COMPONENT="$1"
    echo "Updating build information"
    COMMIT=`git rev-parse --verify --short HEAD`
    DATE=`date`
    ARCH=`uname -m`
    TMPL_DATE="$DATE"
    RELEASE_VERSION=`git branch --no-color | sed -e '/^[^*]/d' -e 's/* \(.*\)/\1/'`
    echo "git hash        : $COMMIT"
    echo "arch            : $ARCH"
    echo "date            : $DATE"
    echo "component       : ${TMPL_COMPONENT}"
    echo "release version : $RELEASE_VERSION"
    perl -pi -e "s/TMPL_VERSION/$COMMIT/g" jark
    perl -pi -e "s/TMPL_ARCH/${ARCH}/g" jark
    perl -pi -e "s/TMPL_DATE/${TMPL_DATE}/g" jark
    perl -pi -e "s/TMPL_COMPONENT/${TMPL_COMPONENT}/g" jark
    exit 0
}

generate_jark() {
    if [ -e "payload.tar" ]; then
        gzip payload.tar
        cat ${WRAP_DIR}/jark.bin payload.tar.gz > jark
        rm payload.tar.gz
        chmod +x jark
        echo "jark self extracting script created"
    else
        echo "payload.tar.gz does not exist"
        exit 1
    fi
}

# begin building

if [ "$1" == "--jarkc" ] || [ "$1" == "jarkc" ]; then
    echo "building jarkc"
    build_jarkc
    exit 0
fi

echo "Adding common components ..."
tar cf payload.tar ${COMMON_COMPONENTS}

TMPL_COMPONENT="client"

if [ $CUSTOM == "no" ]; then
    echo "building both server and client components"
    TMPL_COMPONENT="server"
    build_server
    build_client
else
    if [ "$1" == "--client" ] || [ "$1" == "client" ]; then
        echo "building client components"
        TMPL_COMPONENT="client"
        build_client
    fi

    if [ "$1" == "--server" ] || [ "$1" == "server" ]; then
        echo "building server components"
        TMPL_COMPONENT="server"
        build_server
    fi

   
fi

generate_jark
update_version ${TMPL_COMPONENT}
exit 0




