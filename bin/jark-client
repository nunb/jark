#!/usr/bin/env python

import socket, sys, os
import simplejson
from optparse import OptionParser

def send(host, port, message):
    try:
        c = socket.create_connection((host, port));
    except:
        return False
    f = c.makefile('rw')
    f.writelines(message)
    f.flush()
    return f

def escape_args(a):
    args = ['\\"%s\\"' % x for x in a]
    args = " ".join(args)
    return args

def dispatch(args):
    message = '(do (require \'jark.client)'
    message += '(println (jark.client/send "(jark.ns/dispatch %s)")))\n' % args
    return message

def require(ns):
    message = '(do (require \'jark.client)'
    message += '(println (jark.client/send "(require \'%s)")))\n' % args
    return message

def decode_response(f):
    prefix="clojure.core=>"
    for line in f:
        if "Exception" in line:
            print message
            print line

        if line.startswith(prefix):
            line = line[(len(prefix) + 1):]
        if line.startswith('#<nrepl'):
            break
        if line.strip() in ['nil', 'null']:
            break
    
        try:
            a = simplejson.loads(line)
        except simplejson.decoder.JSONDecodeError:
            break
        return a

def format_response(r):
    if type(r).__name__=='list':
        for i in r:
            if not i == "":
                print i
                
    elif type(r).__name__=='dict':
        for k, v in sorted(r.items()):
            print '%-5s : %5s' % (k, v)
    else:
        print r
    return True

if __name__ == '__main__':
    parser = OptionParser(usage="usage: %prog [options] namespace function args",
                          version="%prog 1.0")
    
    parser.add_option("-s", "--host",
                      action="store",
                      dest="host",
                      default="localhost",
                      help="nrepl server hostname")
    parser.add_option("-p", "--port",
                      action="store",
                      dest="port",
                      default=9500,
                      help="nrepl server port",)
    (options, args) = parser.parse_args()

    if len(args) < 1:
        parser.error("wrong number of arguments")

    message = dispatch(escape_args(args))
    f = send(options.host, options.port, message)

    r = decode_response(f)
    format_response(r)

    sys.exit(0)
