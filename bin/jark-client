#!/usr/bin/env python

import socket, sys, os
import simplejson

host_file = '%s/.cljr/config/jark.host' % os.getenv('HOME')
port_file = '%s/.cljr/config/jark.port' % os.getenv('HOME')

if os.path.exists(host_file):
    host = open(host_file).read().strip()
else:
    host = "localhost"

if os.path.exists(port_file):
    port = open(port_file).read().strip()
else:
    port = 9500

port = int(port)


try:
    c = socket.create_connection((host, port));
except:
    sys.exit(1)

f = c.makefile('rw')

try:
    args = sys.argv[2]
except:
    args = None

if args:
    f.writelines('(do (require \'jark.client) (println (jark.client/send "(%s \\"%s\\")")))\n' % \
                     (sys.argv[1], sys.argv[2]))
else:
    f.writelines('(do (require \'jark.client) (println (jark.client/send "(%s)")))\n' % sys.argv[1])
    
f.flush()

prefix="clojure.core=>"
for line in f:

    if line.startswith(prefix):
        line = line[(len(prefix) + 1):]
    if line.startswith('#<nrepl'):
        break
    if line.strip() in ['nil', 'null']:
        break
    
    try:
        a = simplejson.loads(line)
    except simplejson.decoder.JSONDecodeError:
        break

    if type(a).__name__=='list':
        for i in a:
            if not i == "":
                print i

    elif type(a).__name__=='dict':
        for k, v in sorted(a.items()):
            print '%-15s : %15s' % (k, v)
    else:
        print a

sys.exit(0)
