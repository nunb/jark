#!/bin/bash

VERSION="0.1"

MOD=$1
CLJR_ROOT="$HOME/.cljr"
CLJR_CP="$HOME/.cljr/lib"
CLJR_BIN="$HOME/.cljr/bin"

ARCH=`uname -m`
NG="${CLJR_BIN}/ng"

readlink_e() {
    self="$0"
    while test -h "$self"; do
	cd "$(dirname $self)"
	self=`readlink "$self"`
    done
    cd "$(dirname $self)"
    pwd
}

JARK=$(readlink_e)/jark || jark

JARK_JAR="${CLJR_CP}/jark-${VERSION}.jar"
CLOJURE_JARS="${CLJR_CP}/clojure-1.2.0.jar:${CLJR_CP}/clojure-contrib-1.2.0.jar"
DEP_JARS="${CLJR_CP}/nailgun-0.7.1.jar:${CLJR_CP}/swank-clojure-1.2.0.jar:${CLJR_CP}/classpath-manager-1.1.0.jar"

JARK_CP="${CLOJURE_JARS}:${DEP_JARS}:${JARK_JAR}:"
JARK_MODULES_DIR="${CLJR_CP}/jark"

#exports
export JARK
export JARK_JAR
export DEP_JARS
export JARK_CP
export NG
export CLJR_ROOT
export CLJR_CP
export CLJR_BIN

mkdir -p ${CLJR_CP}
mkdir -p ${CLJR_BIN}
mkdir -p ${JARK_MODULES_DIR}

extract() {
    export TMPDIR=`mktemp -d /tmp/jark.XXXXXX`
    ARCHIVE=`awk '/^__ARCHIVE_BELOW__/ {print NR + 1; exit 0; }' $0`
    tail -n+$ARCHIVE $0 | tar xz -C $TMPDIR
    CDIR=`pwd`
    cd $TMPDIR

    cp -av lib/*.jar ${CLJR_CP}/
    cp -av *.jar ${CLJR_CP}/
    cp -av bin/ng-${ARCH} ${NG}
     chmod +x ${NG}
    cp -av modules/* ${JARK_MODULES_DIR}/

    cd $CDIR
    rm -rf $TMPDIR
    echo "Installed successfully."
    exit 0
}

if [ ! -e ${JARK_JAR} ] || [ ! -e $NG ]; then
    extract
fi

if [ -z $1 ]; then
    echo "USAGE: `basename $0` NAMESPACE|MODULE COMMAND [ARGS]"
    echo "e.g. `basename $0` swank.util.sys get-pid"
    echo
    echo "Available modules:"
    for i in `ls ${JARK_MODULES_DIR}/*.*`; do 
        MODULE=`basename $i | cut -d '.' -f 1` 
        EXT=`basename $i | cut -d '.' -f 2` 
        if [ "$EXT" == "sh" ]; then
            source $i
            echo -en "\e[00;31m$MODULE\e[00m  - \e[00;32m$DOC\e[00m\n"
            help
        fi

        if [ "$EXT" == "clj" ]; then
            $NG jark.core jark.core jark-load ${MODULE_CLJ} 2&> /dev/null
            echo -en "\e[00;31m$MODULE\e[00m\n"
            $NG jark.core jark.${MODULE} | head -n1 | awk 'sub(".....$", "")'
        fi

    done
    exit 0
fi    

if [ $MOD == "install" ]; then
    extract
fi

MODULE_SH=${JARK_MODULES_DIR}/$MOD.sh
MODULE_CLJ=${JARK_MODULES_DIR}/$MOD.clj

if [ -e ${MODULE_SH} ]; then
    source ${MODULE_SH}
    if [ -z $3 ]; then
        ${2} 
    else
        ${2} ${3}
   fi
elif [ -e ${MODULE_CLJ} ]; then
    MODULE=`basename ${MODULE_CLJ} | cut -d '.' -f 1` 
    $NG jark.core jark.core jark-load ${MODULE_CLJ} 2&> /dev/null
    $NG jark.core jark.core jark-compile ${JARK_MODULES_DIR} jark.${MODULE} 2&> /dev/null
    $NG jark.core jark.${MODULE} ${2}
else
    $NG jark.core $@
fi

exit 0

__ARCHIVE_BELOW__
