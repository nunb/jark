#!/bin/bash

VERSION="TMPL_VERSION"
JARK_RELEASE_VERSION="1.0"
BUILD_DATE="TMPL_DATE"
BUILD_COMPONENT="TMPL_COMPONENT"

MOD=$1
CLJR_ROOT="$HOME/.cljr"
CLJR_CP="${CLJR_ROOT}/lib"
CLJR_BIN="${CLJR_ROOT}/bin"

ARCH=`uname -m`

readlink_e() {
    self="$0"
    while test -h "$self"; do
	cd "$(dirname $self)"
	self=`readlink "$self"`
    done
    cd "$(dirname $self)"
    pwd
}

readlink_f() {
    local f="$1"
    cd "$(dirname $f)"
    echo $(pwd)/`basename $f`
}

readlink_a() {
    local f="$1"
    echo $(basename $f | cut -d '.' -f 2)
}

JARK=$(readlink_e)/jark || jark

if [ -e "${CLJR_CP}/jark-${JARK_RELEASE_VERSION}.jar" ]; then
    JARK_JAR="${CLJR_CP}/jark-${JARK_RELEASE_VERSION}.jar"
else
    JARK_JAR="${CLJR_CP}/jark.jar"
fi

CLOJURE_JARS="${CLJR_CP}/clojure-1.2.0.jar:${CLJR_CP}/clojure-contrib-1.2.0.jar"
DEP_JARS="${CLJR_CP}/tools.nrepl-0.0.4.jar:${CLJR_CP}/swank-clojure-1.2.0.jar:${CLJR_CP}/classpath-manager-1.1.0.jar"

JARK_CP="${CLOJURE_JARS}:${DEP_JARS}:${JARK_JAR}:"
JARK_MODULES_DIR="${CLJR_CP}/jark"
JARK_CONFIG_DIR="${CLJR_ROOT}/config"
JARK_BIN="${CLJR_BIN}/jark-client"


# some cleanups

get_pid() {
    if [ -e ${JARK_CONFIG_DIR}/jark.pid ]; then
        p=$(cat ${JARK_CONFIG_DIR}/jark.pid)
        if [ $p ]; then
            echo $p
        else
            echo 0
        fi
    else
        echo 0
    fi
}

get_port() {
    if [ -e ${JARK_CONFIG_DIR}/jark.port ]; then
        p=$(cat ${JARK_CONFIG_DIR}/jark.port)
        if [ $p ]; then
            echo $p
        else
            echo 9500
        fi
    else
        echo 9500
    fi
}

get_host() {
    if [ -e ${JARK_CONFIG_DIR}/jark.host ]; then
        p=$(cat ${JARK_CONFIG_DIR}/jark.host)
        if [ $p ]; then
            echo $p
        else
            echo "localhost"
        fi
    else
        echo "localhost"
    fi
}


get_ns() {
    if [ -e ${JARK_CONFIG_DIR}/jark.ns ]; then
        p=$(cat ${JARK_CONFIG_DIR}/jark.ns)
        if [ "$p" ]; then
            echo "$p"
        else
            echo "user"
        fi
    else
        echo "user"
    fi
}

JARK_CLIENT="${JARK_BIN} --host $(get_host) --port $(get_port)"


is_jark_running() {
    $JARK_CLIENT vm uptime 2&> /dev/null
    if [ $? == "0" ]; then
        echo "yes"
    else
        echo "no"
    fi
}

clj_temp_file() {
    local f="$1"
    echo "/tmp/$(basename $f).clj"
}

require() {
    local module="$1"
    $JARK_CLIENT -r "jark.$module"
}

running=`is_jark_running`

if [ "$1"  == "repl" ]; then
    # TODO: remember last used repl
    if [ -z $2 ]; then
        LAST_REPL=$(get_ns)
    else
        LAST_REPL=$2
    fi
    jark ns repl ${LAST_REPL}
    exit 0
fi

if [ "$1"  == "run" ]; then
    if [ -z $2 ]; then
        MAIN="clojure.main"
    else
        MAIN=$2
    fi
    jark cp run ${MAIN}
    exit 0
fi

if [ "$1"  == "version" ]; then
    echo "git hash: $VERSION"
    echo "build: $BUILD_DATE"
    exit 0
fi

if [ "$1"  == "--version" ]; then
    echo "git hash: $VERSION"
    echo "build: $BUILD_DATE"
    exit 0
fi

#exports
export JARK
export JARK_JAR
export DEP_JARS
export JARK_CP
export JARK_CLIENT
export CLJR_ROOT
export CLJR_CP
export CLJR_BIN
export is_jark_running
export VERSION
export JARK_MODULES_DIR
export JARK_CONFIG_DIR
export readlink_f
export require

mkdir -p ${CLJR_CP}
mkdir -p ${CLJR_BIN}
mkdir -p ${JARK_MODULES_DIR}


extract_common() {
    export TMPDIR=`mktemp -d /tmp/jark.XXXXXX`
    ARCHIVE=`awk '/^__ARCHIVE_BELOW__/ {print NR + 1; exit 0; }' $0`
    tail -n+$ARCHIVE $0 | tar xz -C $TMPDIR
    CDIR=`pwd`
    cd $TMPDIR
    cp -av bin/jark-client ${JARK_BIN}
    cp -av bin/shflags ${CLJR_BIN}/
    cp -av bin/simplejson.py ${CLJR_BIN}/
    cp -av bin/clj_completions ${CLJR_BIN}/
    chmod +x ${JARK_BIN}
    cp -av modules/* ${JARK_MODULES_DIR}/
    mkdir -p ${JARK_CONFIG_DIR}
}

extract_server() {
    cp -av lib/*.jar ${CLJR_CP}/
    cp -av *.jar ${CLJR_CP}/
    cp -av bin/project-cljr.clj ${CLJR_ROOT}/project.clj
    cp jark-deps.txt ${CLJR_CP}/
}

extract_client() {
    cp -av bin/jark-client ${JARK_BIN}
}

extract_finish() {
    cd $CDIR
    rm -rf $TMPDIR
    echo "Installed successfully."
    exit 0
}

if [ -z $1 ]; then
    echo "USAGE: `basename $0` MODULE COMMAND [ARGS]"
    if [ $running == "no" ]; then
        echo "Vm is not running, run jark vm start"
        exit 1
    fi
    echo -en "\e[00;34mAvailable modules:\e[00m\n"
    for i in `ls ${JARK_MODULES_DIR}/*.*`; do 
        MODULE=`basename $i | cut -d '.' -f 1` 
        EXT=`basename $i | cut -d '.' -f 2` 
        if [ "$EXT" == "sh" ]; then
            source $i
            echo -en "$MODULE\t- $(commands)\n"
            
        fi

        if [ "$EXT" == "clj" ]; then
            if [[ $MODULE == _* ]]; then 
                continue 
            fi
            if [ $running == "yes" ]; then
                $JARK_CLIENT jark.core jark.core jark-load $i 2&> /dev/null
                echo -en "$MODULE\t- `$JARK_CLIENT jark.core jark.core about jark.${MODULE} | head -n1 | awk 'sub("....$", "")'`\n"
            fi
        fi

    done
    exit 0

fi    

if [ $MOD == "install" ]; then
    extract_common
    extract_${BUILD_COMPONENT}
    extract_finish
    exit 0
fi


MODULE_SH=${JARK_MODULES_DIR}/$MOD.sh
MODULE_CLJ=${JARK_MODULES_DIR}/$MOD.clj

if [ -e ${MODULE_SH} ]; then
    source ${MODULE_SH}
    if [ -z $2 ]; then
        echo "Available commands: " 
        _doc
        exit 1
    fi
    ${2} "${@:3}"
    exit 0
elif [ -e ${MODULE_CLJ} ]; then
    MODULE=`basename ${MODULE_CLJ} | cut -d '.' -f 1` 
    $JARK_CLIENT jark.core jark.core jark-load ${MODULE_CLJ} 2&> /dev/null
    $JARK_CLIENT jark.core jark.core jark-compile ${JARK_MODULES_DIR} jark.${MODULE} 2&> /dev/null
    #$JARK_CLIENT jark.core jark.${MODULE} "${@:2}"
    exit 0
elif [ -e "$1" ] && [ ! -d "$1" ]; then
    if [ "$running" == "no" ]; then
        jark vm start 2&> /dev/null
    fi
    if [ "$(readlink_a $1)" == `basename $1` ]; then
        cp $(readlink_f $1) $(clj_temp_file $1)
        LOAD_FILE=$(clj_temp_file $1)
    else
        LOAD_FILE=$(readlink_f $1)
    fi
    LNS=`jark ns load $LOAD_FILE`
    NS=`echo $LNS | cut -d '/' -f 1 | cut -d "'" -f 2`
    $JARK_CLIENT jark.core $NS -main "${@:2}"
    rm -f $(clj_temp_file $1)
    exit 0
else
    ${JARK_CLIENT} "${@:1}"
    exit 0
fi


exit 0

__ARCHIVE_BELOW__
